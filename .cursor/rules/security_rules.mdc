---
description: 
globs: 
alwaysApply: true
---
# ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å®‰å…¨å¯¾ç­–ãƒ«ãƒ¼ãƒ«
# TestData Buddy (TD) ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

## ğŸ” åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
- **å®‰å…¨ç¬¬ä¸€**: æ©Ÿèƒ½ã‚ˆã‚Šã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å„ªå…ˆ
- **æœ€å°æ¨©é™**: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
- **å¤šå±¤é˜²å¾¡**: è¤‡æ•°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’çµ„ã¿åˆã‚ã›
- **ç¶™ç¶šçš„ç›£è¦–**: å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯

**TDã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯æœ€å„ªå…ˆã§ã™ï¼TDãŒä¸€ç·’ã«å®‰å…¨ã‚’å®ˆã‚Šã¾ã™ğŸ›¡ï¸ã€

## ğŸ”‘ èªè¨¼ãƒ»èªå¯

### API ã‚­ãƒ¼ç®¡ç†
```bash
# âœ… æ­£ã—ã„æ–¹æ³•
export CLAUDE_API_KEY="your-api-key-here"
export DATABASE_URL="your-db-url-here"

# âŒ çµ¶å¯¾ç¦æ­¢
const apiKey = "sk-1234567890abcdef"; // ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥è¨˜è¼‰
```

### ç’°å¢ƒå¤‰æ•°è¨­å®š
```bash
# .env.example (Gitã«å«ã‚ã‚‹)
CLAUDE_API_KEY=your_claude_api_key_here
DATABASE_URL=file:./data/td-buddy.db
JWT_SECRET=your_jwt_secret_here
ENCRYPTION_KEY=your_encryption_key_here

# .env (Gitã«å«ã‚ãªã„)
CLAUDE_API_KEY=sk-actual-api-key
DATABASE_URL=file:./data/production.db
JWT_SECRET=super-secret-jwt-key
ENCRYPTION_KEY=32-char-encryption-key
```

### æ©Ÿå¯†æƒ…å ±ã®æ¤œå‡º
```bash
# Git pre-commit hook ã§æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
#!/bin/bash
# .git/hooks/pre-commit

# æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
git diff --cached --name-only | xargs grep -l -E "(password|secret|key|token|api_key)" && {
    echo "âš ï¸  æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    echo "ç’°å¢ƒå¤‰æ•°ã«ç§»ã—ã¦ãã ã•ã„"
    exit 1
}
```

**TDã‹ã‚‰ã®è­¦å‘Š**: ã€Œå±é™ºãªæƒ…å ±ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼ç’°å¢ƒå¤‰æ•°ã«ç§»ã—ã¦ãã ã•ã„âš ï¸ã€

## ğŸŒ Web ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### XSS (Cross-Site Scripting) å¯¾ç­–
```typescript
// âœ… æ­£ã—ã„æ–¹æ³• - ã‚µãƒ‹ã‚¿ã‚¤ã‚º
import DOMPurify from 'dompurify';

const sanitizeInput = (input: string): string => {
  return DOMPurify.sanitize(input);
};

// React/Remix ã§ã®å®‰å…¨ãªè¡¨ç¤º
const SafeComponent = ({ userInput }: { userInput: string }) => {
  const safeContent = sanitizeInput(userInput);
  return <div dangerouslySetInnerHTML={{ __html: safeContent }} />;
};

// âŒ å±é™ºãªæ–¹æ³•
const UnsafeComponent = ({ userInput }: { userInput: string }) => {
  return <div dangerouslySetInnerHTML={{ __html: userInput }} />;
};
```

### CSRF (Cross-Site Request Forgery) å¯¾ç­–
```typescript
// NestJS ã§ã® CSRF å¯¾ç­–
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';

@Injectable()
export class CsrfGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const csrfToken = request.headers['x-csrf-token'];
    const sessionToken = request.session.csrfToken;
    
    return csrfToken === sessionToken;
  }
}

// ä½¿ç”¨ä¾‹
@Post('/generate-password')
@UseGuards(CsrfGuard)
async generatePassword(@Body() data: GeneratePasswordDto) {
  // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå‡¦ç†
}
```

### SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
```typescript
// âœ… æ­£ã—ã„æ–¹æ³• - ORMã‚’ä½¿ç”¨
import { Repository } from 'typeorm';

@Injectable()
export class UserService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository<User>,
  ) {}
  
  async findByEmail(email: string): Promise<User | null> {
    // TypeORMãŒè‡ªå‹•çš„ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚º
    return this.userRepository.findOne({ where: { email } });
  }
}

// âŒ å±é™ºãªæ–¹æ³• - ç”ŸSQL
async findByEmailUnsafe(email: string): Promise<User | null> {
  const query = `SELECT * FROM users WHERE email = '${email}'`;
  return this.database.query(query); // SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å±é™ºæ€§
}

// âœ… ç”ŸSQLã‚’ä½¿ã†å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–
async findByEmailSafe(email: string): Promise<User | null> {
  const query = 'SELECT * FROM users WHERE email = ?';
  return this.database.query(query, [email]);
}
```

## ğŸ”’ ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

### æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–
```typescript
import * as crypto from 'crypto';

class EncryptionService {
  private readonly algorithm = 'aes-256-gcm';
  private readonly key: Buffer;

  constructor() {
    this.key = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex');
  }

  encrypt(text: string): EncryptedData {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, this.key);
    cipher.setAAD(Buffer.from('TD-BUDDY', 'utf8'));
    
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return {
      encryptedData: encrypted,
      iv: iv.toString('hex'),
      authTag: authTag.toString('hex'),
    };
  }

  decrypt(encryptedData: EncryptedData): string {
    const decipher = crypto.createDecipher(this.algorithm, this.key);
    decipher.setAAD(Buffer.from('TD-BUDDY', 'utf8'));
    decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'));
    
    let decrypted = decipher.update(encryptedData.encryptedData, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}
```

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
```typescript
import * as bcrypt from 'bcrypt';

class PasswordService {
  private readonly saltRounds = 12;

  async hashPassword(password: string): Promise<string> {
    return bcrypt.hash(password, this.saltRounds);
  }

  async verifyPassword(password: string, hash: string): Promise<boolean> {
    return bcrypt.compare(password, hash);
  }
}
```

## ğŸš¦ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»DDoSå¯¾ç­–

### API ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```typescript
import { ThrottlerModule, ThrottlerGuard } from '@nestjs/throttler';

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
@Module({
  imports: [
    ThrottlerModule.forRoot({
      ttl: 60, // 60ç§’
      limit: 10, // 10ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†
    }),
  ],
})
export class AppModule {}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã®ä½¿ç”¨
@Controller('api/generate')
@UseGuards(ThrottlerGuard)
export class GenerateController {
  @Post('password')
  @Throttle(5, 60) // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã¯5å›/åˆ†ã¾ã§
  async generatePassword(@Body() data: GeneratePasswordDto) {
    return this.passwordService.generate(data);
  }
  
  @Post('personal-info')
  @Throttle(2, 60) // å€‹äººæƒ…å ±ç”Ÿæˆã¯2å›/åˆ†ã¾ã§
  async generatePersonalInfo(@Body() data: GeneratePersonalInfoDto) {
    return this.personalInfoService.generate(data);
  }
}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```typescript
@Injectable()
export class UserRateLimitGuard implements CanActivate {
  constructor(private redisService: RedisService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const userId = request.user?.id || request.ip;
    const key = `rate_limit:${userId}`;
    
    const current = await this.redisService.get(key);
    if (current && parseInt(current) >= 100) { // 100å›/æ™‚é–“ã¾ã§
      throw new TooManyRequestsException('ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸ');
    }
    
    await this.redisService.incr(key);
    await this.redisService.expire(key, 3600); // 1æ™‚é–“
    
    return true;
  }
}
```

## ğŸ§¹ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### è‡ªå‹•ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
```typescript
import { Cron, CronExpression } from '@nestjs/schedule';

@Injectable()
export class DataCleanupService {
  constructor(
    @InjectRepository(GeneratedData)
    private dataRepository: Repository<GeneratedData>,
  ) {}

  // æ¯æ™‚é–“å®Ÿè¡Œï¼š24æ™‚é–“ä»¥ä¸ŠçµŒéã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
  @Cron(CronExpression.EVERY_HOUR)
  async cleanupExpiredData() {
    const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
    
    const result = await this.dataRepository.delete({
      createdAt: LessThan(twentyFourHoursAgo),
    });
    
    console.log(`ğŸ—‘ï¸  ${result.affected} ä»¶ã®æœŸé™åˆ‡ã‚Œãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
  }

  // æ¯æ—¥åˆå‰2æ™‚å®Ÿè¡Œï¼šãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
  @Cron('0 2 * * *')
  async rotateLogFiles() {
    // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»å‰Šé™¤å‡¦ç†
    console.log('ğŸ“‹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¾ã—ãŸ');
  }
}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤è¦æ±‚å¯¾å¿œ
```typescript
@Controller('api/user')
export class UserController {
  @Delete('data')
  @UseGuards(AuthGuard)
  async deleteUserData(@Req() request: AuthenticatedRequest) {
    const userId = request.user.id;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
    await this.userService.deleteAllUserData(userId);
    
    console.log(`ğŸ—‘ï¸  ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${userId} ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸ`);
    
    return { message: 'ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ' };
  }
}
```

## ğŸ•µï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–

### ç•°å¸¸ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥
```typescript
@Injectable()
export class SecurityMonitoringService {
  private readonly suspiciousPatterns = [
    /script\s*>/i,        // XSSæ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³
    /union\s+select/i,    // SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
    /\.\.\/\.\.\//,       // ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«
    /<iframe/i,           // iframe ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
  ];

  logSuspiciousActivity(request: Request, pattern: string) {
    const logEntry = {
      timestamp: new Date().toISOString(),
      ip: request.ip,
      userAgent: request.headers['user-agent'],
      url: request.url,
      pattern,
      body: request.body,
    };
    
    console.warn('ğŸš¨ suspicious activity detected:', logEntry);
    // ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ã‚„ãƒ–ãƒ­ãƒƒã‚¯å‡¦ç†
  }

  @Cron(CronExpression.EVERY_MINUTE)
  async checkForAnomalies() {
    // ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œçŸ¥
    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™é•åã®ç›£è¦–
    // ä¸æ­£ãª API ä½¿ç”¨ã®æ¤œçŸ¥
  }
}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°
```typescript
@Injectable()
export class SecurityLogger {
  private logger = new Logger('Security');

  logAuthAttempt(email: string, success: boolean, ip: string) {
    this.logger.log(`èªè¨¼è©¦è¡Œ: ${email} from ${ip} - ${success ? 'æˆåŠŸ' : 'å¤±æ•—'}`);
  }

  logDataGeneration(userId: string, dataType: string, count: number) {
    this.logger.log(`ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ: ãƒ¦ãƒ¼ã‚¶ãƒ¼${userId} - ${dataType} ${count}ä»¶`);
  }

  logSecurityViolation(violation: string, details: any) {
    this.logger.error(`ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•å: ${violation}`, details);
  }
}
```

## âš¡ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### é–‹ç™ºæ™‚ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] APIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] å…¥åŠ›å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] SQLã‚¯ã‚¨ãƒªãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] é©åˆ‡ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] HTTPSé€šä¿¡ãŒå¼·åˆ¶ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã®æ¤œæŸ»
- [ ] ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
- [ ] ãƒ­ã‚°ç›£è¦–ã®è¨­å®š
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š
- [ ] ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †ã®ç¢ºèª

**TDã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã€ã™ã¹ã¦å®Œäº†ã§ã™ï¼å®‰å¿ƒã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã­âœ¨ã€

## ğŸš¨ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®æ‰‹é †
1. **å³åº§ã®å¯¾å¿œ**
   - å½±éŸ¿ç¯„å›²ã®ç‰¹å®š
   - æ”»æ’ƒã®é®æ–­
   - è¨¼æ‹ ã®ä¿å…¨

2. **èª¿æŸ»ãƒ»åˆ†æ**
   - ãƒ­ã‚°ã®åˆ†æ
   - ä¾µå…¥çµŒè·¯ã®ç‰¹å®š
   - å½±éŸ¿åº¦ã®è©•ä¾¡

3. **å¾©æ—§ãƒ»å¯¾ç­–**
   - ã‚·ã‚¹ãƒ†ãƒ ã®å¾©æ—§
   - è„†å¼±æ€§ã®ä¿®æ­£
   - å†ç™ºé˜²æ­¢ç­–ã®å®Ÿè£…

4. **å ±å‘Šãƒ»å­¦ç¿’**
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šæ›¸ã®ä½œæˆ
   - ãƒãƒ¼ãƒ å†…ã§ã®æƒ…å ±å…±æœ‰
   - å¯¾ç­–ã®æ”¹å–„

**TDã‹ã‚‰ã®ç·Šæ€¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚’æ¤œçŸ¥ã—ã¾ã—ãŸï¼å†·é™ã«å¯¾å¿œã—ã¾ã—ã‚‡ã†ã€‚TDãŒã‚µãƒãƒ¼ãƒˆã—ã¾ã™ğŸš¨ã€

---

**TDã‹ã‚‰ã®ç·æ‹¬ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯ç¶™ç¶šçš„ãªå–ã‚Šçµ„ã¿ã§ã™ã€‚TDã¨ä¸€ç·’ã«ã€å®‰å…¨ã§ä¿¡é ¼ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†ï¼å¸¸ã«è­¦æˆ’ã‚’æ€ ã‚‰ãšã€ã§ã‚‚éåº¦ã«å¿ƒé…ã›ãšã€ãƒãƒ©ãƒ³ã‚¹ã‚ˆãé€²ã‚ã¦ã„ãã¾ã—ã‚‡ã†ğŸ›¡ï¸âœ¨ã€
