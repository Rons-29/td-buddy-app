# TestData Buddy トラブルシューティングガイド

## 🚨 よくある問題と解決策

### 1. 起動・セットアップに関する問題

#### 問題: `pnpm install` が失敗する
**症状**: 依存関係のインストールでエラーが発生する

**原因と解決策**:
```bash
# Node.jsバージョンを確認
node --version  # v18.0.0以上であることを確認

# pnpmを最新版に更新
npm install -g pnpm@latest

# キャッシュをクリア
pnpm store prune

# 依存関係を再インストール
rm -rf node_modules
rm pnpm-lock.yaml
pnpm install
```

#### 問題: 開発サーバーが起動しない
**症状**: `pnpm run dev` でエラーが発生する

**原因と解決策**:
```bash
# ポート使用状況を確認
lsof -i :3000
lsof -i :3001

# 使用中のプロセスを終了
kill -9 $(lsof -ti:3000,3001)

# 環境変数を確認
cat .env
# 必要に応じて .env.example をコピー
cp .env.example .env

# データベースファイルが存在することを確認
ls -la data/
# 存在しない場合は初期化
mkdir -p data
pnpm run db:migrate
```

#### 問題: データベース接続エラー
**症状**: SQLite connection failed

**診断スクリプト**:
```typescript
// scripts/diagnose-db.js
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.join(__dirname, '../data/td-buddy.sqlite');

console.log('🔍 データベース診断を開始...');
console.log(`データベースパス: ${dbPath}`);

// ファイル存在確認
const fs = require('fs');
if (!fs.existsSync(dbPath)) {
  console.error('❌ データベースファイルが存在しません');
  console.log('💡 解決策: pnpm run db:migrate を実行してください');
  process.exit(1);
}

// 接続テスト
const db = new sqlite3.Database(dbPath, (err) => {
  if (err) {
    console.error('❌ データベース接続エラー:', err.message);
    console.log('💡 解決策: データベースファイルを削除して再作成してください');
    console.log('   rm data/td-buddy.sqlite && pnpm run db:migrate');
  } else {
    console.log('✅ データベース接続成功');
    
    // テーブル存在確認
    db.all("SELECT name FROM sqlite_master WHERE type='table'", [], (err, rows) => {
      if (err) {
        console.error('❌ テーブル一覧取得エラー:', err.message);
      } else {
        console.log('📋 存在するテーブル:', rows.map(row => row.name));
        if (rows.length === 0) {
          console.log('💡 マイグレーションが必要です: pnpm run db:migrate');
        }
      }
      db.close();
    });
  }
});
```

### 2. Claude API 関連の問題

#### 問題: Claude API キーが無効
**症状**: Unauthorized error または API key invalid

**解決手順**:
```bash
# 1. 環境変数を確認
echo $CLAUDE_API_KEY

# 2. .envファイルを確認
cat .env | grep CLAUDE

# 3. APIキーの形式を確認（sk-ant-api03-で始まるべき）
# 4. Console.anthropic.com でキーの有効性を確認

# 5. テストスクリプトで確認
node scripts/test-claude-api.js
```

**APIテストスクリプト**:
```typescript
// scripts/test-claude-api.js
const Anthropic = require('@anthropic-ai/sdk');

async function testClaudeAPI() {
  const apiKey = process.env.CLAUDE_API_KEY;
  
  if (!apiKey) {
    console.error('❌ CLAUDE_API_KEY環境変数が設定されていません');
    return;
  }

  if (!apiKey.startsWith('sk-ant-api03-')) {
    console.error('❌ 無効なAPIキー形式です');
    return;
  }

  try {
    const anthropic = new Anthropic({ apiKey });
    
    const response = await anthropic.messages.create({
      model: 'claude-3-sonnet-20240229',
      max_tokens: 100,
      messages: [{ role: 'user', content: 'テスト' }]
    });

    console.log('✅ Claude API接続成功');
    console.log('📝 レスポンス:', response.content[0].text);
  } catch (error) {
    console.error('❌ Claude API エラー:', error.message);
    
    if (error.status === 401) {
      console.log('💡 APIキーを確認してください');
    } else if (error.status === 429) {
      console.log('💡 レート制限に達しています。しばらく待ってから再試行してください');
    } else if (error.status === 500) {
      console.log('💡 Claude APIサーバーエラー。公式ステータスページを確認してください');
    }
  }
}

testClaudeAPI();
```

#### 問題: Claude APIレスポンスが期待と異なる
**症状**: JSON解析エラーまたは構造化されていないレスポンス

**デバッグ手順**:
```typescript
// src/modules/ai/claude-debug.service.ts
@Injectable()
export class ClaudeDebugService {
  async debugPrompt(prompt: string): Promise<void> {
    console.log('🔍 Claude API デバッグ');
    console.log('📝 送信プロンプト:', prompt);
    
    try {
      const response = await this.claudeService.parseNaturalLanguage(prompt);
      console.log('📥 生レスポンス:', response);
      
      // JSON検証
      try {
        const parsed = JSON.parse(response.content[0].text);
        console.log('✅ JSON解析成功:', parsed);
      } catch (parseError) {
        console.error('❌ JSON解析失敗:', parseError.message);
        console.log('📝 生テキスト:', response.content[0].text);
        
        // 一般的な修正を試行
        const cleaned = this.cleanResponseText(response.content[0].text);
        console.log('🔧 修正試行:', cleaned);
      }
    } catch (error) {
      console.error('❌ API呼び出しエラー:', error);
    }
  }

  private cleanResponseText(text: string): string {
    return text
      .replace(/```json\n?/g, '')
      .replace(/```\n?/g, '')
      .replace(/^[^{]*/, '')
      .replace(/[^}]*$/, '')
      .trim();
  }
}
```

### 3. ファイル生成に関する問題

#### 問題: 大容量ファイル生成でメモリ不足
**症状**: "JavaScript heap out of memory" エラー

**解決策**:
```bash
# 1. Node.jsメモリ制限を増加
export NODE_OPTIONS="--max-old-space-size=4096"  # 4GB

# 2. ストリーミング処理の確認
# file.service.ts でストリーミング処理が適切に実装されているか確認

# 3. バッチサイズを調整
# config/file.config.ts
export const fileConfig = {
  batchSize: 1000,  // デフォルト値を減らす
  maxFileSize: 100 * 1024 * 1024,  // 100MB制限
  streamThreshold: 10000,  // 10,000行を超えたらストリーミング
};
```

**メモリ監視スクリプト**:
```typescript
// scripts/monitor-memory.js
function monitorMemory() {
  setInterval(() => {
    const usage = process.memoryUsage();
    const mb = (bytes) => Math.round(bytes / 1024 / 1024);
    
    console.log(`📊 メモリ使用量: RSS: ${mb(usage.rss)}MB, Heap: ${mb(usage.heapUsed)}/${mb(usage.heapTotal)}MB`);
    
    if (usage.heapUsed > 400 * 1024 * 1024) { // 400MB
      console.warn('⚠️  メモリ使用量が高くなっています');
    }
  }, 5000);
}

monitorMemory();
```

#### 問題: ファイルダウンロードが失敗する
**症状**: 404 Not Found またはファイルが破損

**診断コマンド**:
```bash
# 1. 生成ファイルディレクトリを確認
ls -la data/generated/

# 2. ファイル権限を確認
ls -la data/generated/*.csv

# 3. ディスク容量を確認
df -h

# 4. ファイルの整合性確認
file data/generated/*.csv
head -n 5 data/generated/*.csv
```

### 4. パフォーマンス問題

#### 問題: レスポンスが遅い
**症状**: APIレスポンス時間が目標値を超える

**パフォーマンス診断**:
```bash
# プロファイリングを有効化
export NODE_ENV=development
export DEBUG=*

# パフォーマンステストを実行
pnpm run test:performance

# 具体的なエンドポイントの測定
curl -w "time_total: %{time_total}\n" -o /dev/null -s "http://localhost:3001/api/generate/password" \
  -H "Content-Type: application/json" \
  -d '{"length":12,"includeUpper":true,"includeLower":true,"includeNumbers":true,"includeSymbols":false}'
```

**ボトルネック分析スクリプト**:
```typescript
// scripts/analyze-performance.js
const { performance, PerformanceObserver } = require('perf_hooks');

// パフォーマンス測定
const obs = new PerformanceObserver((items) => {
  items.getEntries().forEach((entry) => {
    console.log(`⏱️  ${entry.name}: ${entry.duration.toFixed(2)}ms`);
  });
});

obs.observe({ entryTypes: ['measure'] });

// 使用例
performance.mark('password-start');
// パスワード生成処理
performance.mark('password-end');
performance.measure('password-generation', 'password-start', 'password-end');
```

### 5. UI/フロントエンド問題

#### 問題: ページが表示されない
**症状**: 白い画面またはローディングが終わらない

**デバッグ手順**:
```bash
# 1. ブラウザのコンソールエラーを確認
# F12 -> Console タブを確認

# 2. ネットワークタブでAPIリクエストを確認
# F12 -> Network タブを確認

# 3. Remixの開発モードを確認
export NODE_ENV=development
pnpm run dev

# 4. ビルドエラーがないか確認
pnpm run build
```

#### 問題: フォーム送信が動作しない
**症状**: 送信ボタンを押しても反応がない

**確認ポイント**:
```typescript
// デバッグ用のコンポーネント
export function DebugForm() {
  const fetcher = useFetcher();
  
  useEffect(() => {
    console.log('🔍 Fetcher state:', {
      state: fetcher.state,
      data: fetcher.data,
      formAction: fetcher.formAction,
      formMethod: fetcher.formMethod,
    });
  }, [fetcher]);

  const handleSubmit = (event: FormEvent) => {
    console.log('📝 Form submitted:', event.currentTarget);
    // フォーム送信処理
  };

  return (
    <fetcher.Form method="post" onSubmit={handleSubmit}>
      {/* フォーム要素 */}
    </fetcher.Form>
  );
}
```

## 🛠️ 一般的なデバッグツール

### 1. ログレベル調整
```bash
# 詳細ログを有効化
export LOG_LEVEL=debug
export DEBUG=td-buddy:*

# 特定モジュールのみ
export DEBUG=td-buddy:password,td-buddy:file
```

### 2. ヘルスチェックエンドポイント
```typescript
// src/modules/health/health.controller.ts
@Controller('health')
export class HealthController {
  @Get()
  async getHealth() {
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      version: process.env.npm_package_version,
      memory: process.memoryUsage(),
      uptime: process.uptime(),
    };
  }

  @Get('detailed')
  async getDetailedHealth() {
    const dbStatus = await this.checkDatabase();
    const claudeStatus = await this.checkClaudeAPI();
    const diskStatus = await this.checkDiskSpace();

    return {
      database: dbStatus,
      claude: claudeStatus,
      disk: diskStatus,
      memory: process.memoryUsage(),
    };
  }
}
```

### 3. 診断スクリプト集
```bash
# scripts/diagnose.sh
#!/bin/bash

echo "🏥 TestData Buddy システム診断"
echo "================================"

# Node.js環境
echo "📋 Node.js環境:"
node --version
npm --version
pnpm --version

# 環境変数
echo -e "\n📋 環境変数:"
echo "NODE_ENV: ${NODE_ENV:-未設定}"
echo "CLAUDE_API_KEY: ${CLAUDE_API_KEY:+設定済み}"

# ポート使用状況
echo -e "\n📋 ポート使用状況:"
lsof -i :3000 || echo "ポート3000: 使用中でない"
lsof -i :3001 || echo "ポート3001: 使用中でない"

# ディスク容量
echo -e "\n📋 ディスク容量:"
df -h .

# プロセス
echo -e "\n📋 関連プロセス:"
ps aux | grep -E "(node|pnpm)" | grep -v grep

# データベース
echo -e "\n📋 データベース:"
ls -la data/ 2>/dev/null || echo "dataディレクトリが存在しません"

# ログファイル
echo -e "\n📋 最新のログ:"
tail -n 5 logs/*.log 2>/dev/null || echo "ログファイルが見つかりません"

echo -e "\n✅ 診断完了"
```

## 📞 サポート連絡先

### 問題報告時に含める情報
1. **エラーメッセージ**: 完全なスタックトレース
2. **環境情報**: OS、Node.js バージョン、ブラウザ
3. **再現手順**: エラーが発生するまでの具体的な手順
4. **設定情報**: .env ファイルの内容（機密情報を除く）
5. **ログ**: 関連するログファイルの内容

### 緊急度レベル
- **Critical**: サービス完全停止
- **High**: 主要機能が使用不可
- **Medium**: 一部機能に問題
- **Low**: 軽微な問題、改善要望

### よくある質問 (FAQ)

**Q: パスワード生成が同じ結果を返す**  
A: ブラウザキャッシュをクリアするか、シークレットモードで試してください。

**Q: ファイル生成が途中で止まる**  
A: メモリ不足の可能性があります。生成するレコード数を減らして試してください。

**Q: Claude APIが応答しない**  
A: APIキーの有効性とレート制限を確認してください。anthropic のステータスページも確認してください。

**Q: 日本語文字が文字化けする**  
A: ファイルのエンコーディングがUTF-8になっているか確認してください。 