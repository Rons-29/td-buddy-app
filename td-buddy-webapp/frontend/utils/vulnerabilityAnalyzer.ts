import {
  EducationalContent,
  VulnerabilityAnalysis,
  VulnerabilityIssue,
} from '../types/password';

// ä¸€èˆ¬çš„ãªè„†å¼±ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³
const COMMON_PASSWORDS = [
  'password',
  '123456',
  '123456789',
  'qwerty',
  'abc123',
  'password123',
  'admin',
  'letmein',
  'welcome',
  'monkey',
  '1234567890',
  'iloveyou',
];

const KEYBOARD_PATTERNS = [
  'qwerty',
  'asdf',
  'zxcv',
  '1234',
  'qwertyuiop',
  'asdfghjkl',
  'zxcvbnm',
];

const SEQUENTIAL_PATTERNS = [
  '123',
  '234',
  '345',
  '456',
  '567',
  '678',
  '789',
  '890',
  'abc',
  'bcd',
  'cde',
  'def',
  'efg',
  'fgh',
  'ghi',
];

// è„†å¼±æ€§åˆ†æã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
export function analyzePasswordVulnerability(
  password: string,
  vulnerabilityType?: string
): VulnerabilityAnalysis {
  const vulnerabilities: VulnerabilityIssue[] = [];
  let vulnerabilityScore = 0;

  // é•·ã•ã®åˆ†æ
  if (password.length < 8) {
    vulnerabilities.push({
      type: 'length',
      severity: 'critical',
      description: `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ${password.length}æ–‡å­—ï¼‰`,
      impact: 'ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã§æ•°ç§’ã€œæ•°åˆ†ã§ç ´ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
      examples: ['123456', 'abc123'],
    });
    vulnerabilityScore += 30;
  } else if (password.length < 12) {
    vulnerabilities.push({
      type: 'length',
      severity: 'medium',
      description: `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®é•·ã•ãŒæ¨å¥¨å€¤ä»¥ä¸‹ã§ã™ï¼ˆ${password.length}æ–‡å­—ï¼‰`,
      impact: 'ååˆ†ãªæ™‚é–“ãŒã‚ã‚Œã°ç ´ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
    });
    vulnerabilityScore += 15;
  }

  // ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¤œæŸ»
  const lowerPassword = password.toLowerCase();
  if (COMMON_PASSWORDS.some(common => lowerPassword.includes(common))) {
    vulnerabilities.push({
      type: 'common',
      severity: 'critical',
      description: 'ä¸€èˆ¬çš„ã«ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã™',
      impact: 'è¾æ›¸æ”»æ’ƒã§å³åº§ã«ç ´ã‚‰ã‚Œã¾ã™',
      examples: COMMON_PASSWORDS.slice(0, 5),
    });
    vulnerabilityScore += 40;
  }

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œæŸ»
  if (KEYBOARD_PATTERNS.some(pattern => lowerPassword.includes(pattern))) {
    vulnerabilities.push({
      type: 'pattern',
      severity: 'high',
      description: 'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…åˆ—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
      impact: 'ãƒ‘ã‚¿ãƒ¼ãƒ³æ”»æ’ƒã§çŸ­æ™‚é–“ã§ç ´ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™',
      examples: ['qwerty123', 'asdf1234'],
    });
    vulnerabilityScore += 25;
  }

  // é€£ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œæŸ»
  if (SEQUENTIAL_PATTERNS.some(pattern => lowerPassword.includes(pattern))) {
    vulnerabilities.push({
      type: 'pattern',
      severity: 'high',
      description: 'é€£ç¶šã™ã‚‹æ–‡å­—ãƒ»æ•°å­—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
      impact: 'ãƒ‘ã‚¿ãƒ¼ãƒ³æ”»æ’ƒã§ç ´ã‚‰ã‚Œã‚„ã™ããªã‚Šã¾ã™',
      examples: ['123456', 'abcdef'],
    });
    vulnerabilityScore += 20;
  }

  // æ–‡å­—ç¨®ã®å¤šæ§˜æ€§ãƒã‚§ãƒƒã‚¯
  const hasUpper = /[A-Z]/.test(password);
  const hasLower = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);
  const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);

  const charTypeCount = [hasUpper, hasLower, hasNumber, hasSymbol].filter(
    Boolean
  ).length;

  if (charTypeCount < 2) {
    vulnerabilities.push({
      type: 'character-set',
      severity: 'high',
      description: 'ä½¿ç”¨ã—ã¦ã„ã‚‹æ–‡å­—ç¨®ãŒå°‘ãªã™ãã¾ã™',
      impact: 'æ–‡å­—ç¨®ãŒé™å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ”»æ’ƒã®å¯¾è±¡ç¯„å›²ãŒç‹­ããªã‚Šã¾ã™',
    });
    vulnerabilityScore += 20;
  } else if (charTypeCount < 3) {
    vulnerabilities.push({
      type: 'character-set',
      severity: 'medium',
      description: 'æ–‡å­—ç¨®ã®å¤šæ§˜æ€§ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
      impact: 'ã‚ˆã‚Šå¤šãã®æ–‡å­—ç¨®ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å®‰å…¨æ€§ãŒå‘ä¸Šã—ã¾ã™',
    });
    vulnerabilityScore += 10;
  }

  // åå¾©ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œæŸ»
  const repeatedChars = password.match(/(.)\1{2,}/g);
  if (repeatedChars) {
    vulnerabilities.push({
      type: 'pattern',
      severity: 'medium',
      description: 'åŒã˜æ–‡å­—ã®é€£ç¶šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ',
      impact: 'ãƒ‘ã‚¿ãƒ¼ãƒ³ã®äºˆæ¸¬å¯èƒ½æ€§ãŒé«˜ã¾ã‚Šã¾ã™',
      examples: ['aaa', '111', '!!!'],
    });
    vulnerabilityScore += 15;
  }

  // æ•™è‚²ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”Ÿæˆ
  const educationalContent = generateEducationalContent(
    vulnerabilityType,
    vulnerabilities
  );

  // æ¨å¥¨äº‹é …ã®ç”Ÿæˆ
  const recommendations = generateRecommendations(vulnerabilities);

  // æ¯”è¼ƒä¾‹ã®ç”Ÿæˆ
  const comparisonExample = generateComparisonExample(
    password,
    vulnerabilities
  );

  return {
    vulnerabilityScore: Math.min(vulnerabilityScore, 100),
    vulnerabilities,
    recommendations,
    educationalContent,
    comparisonExample,
  };
}

function generateEducationalContent(
  vulnerabilityType?: string,
  vulnerabilities?: VulnerabilityIssue[]
): EducationalContent {
  const baseContent = {
    common: {
      title: 'ä¸€èˆ¬çš„ãªè„†å¼±ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã¤ã„ã¦',
      explanation:
        'ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ”»æ’ƒè€…ã«ã¨ã£ã¦æœ€åˆã®æ¨™çš„ã¨ãªã‚Šã¾ã™ã€‚',
      whyVulnerable: [
        'è¾æ›¸æ”»æ’ƒã§ç°¡å˜ã«ç™ºè¦‹ã•ã‚Œã‚‹',
        'å¤šãã®äººãŒåŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹',
        'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„',
      ],
      attackMethods: [
        {
          name: 'è¾æ›¸æ”»æ’ƒ',
          description: 'ä¸€èˆ¬çš„ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ãŸæ”»æ’ƒ',
          timeToBreak: 'æ•°ç§’ã€œæ•°åˆ†',
          difficulty: 'trivial' as const,
        },
        {
          name: 'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ”»æ’ƒ',
          description: 'äº‹å‰è¨ˆç®—ã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ç”¨',
          timeToBreak: 'å³åº§',
          difficulty: 'easy' as const,
        },
      ],
      realWorldExamples: [
        '2019å¹´ã®Collection #1ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã§ã¯ã€"123456"ãŒæœ€ã‚‚å¤šãä½¿ç”¨ã•ã‚Œã¦ã„ãŸ',
        'LinkedInã®æ¼æ´©ã§ã¯ã€"password"ãŒä¸Šä½ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³',
        'Adobeã®äº‹ä»¶ã§ã¯ã€å˜ç´”ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤§é‡ã«ç™ºè¦‹ã•ã‚ŒãŸ',
      ],
    },
    dictionary: {
      title: 'è¾æ›¸æ”»æ’ƒã®è„†å¼±æ€§',
      explanation:
        'è¾æ›¸ã«è¼‰ã£ã¦ã„ã‚‹å˜èªã‚„ä¸€èˆ¬çš„ãªçµ„ã¿åˆã‚ã›ã¯æ”»æ’ƒã®æ¨™çš„ã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚',
      whyVulnerable: [
        'è¾æ›¸æ”»æ’ƒãƒ„ãƒ¼ãƒ«ã§è‡ªå‹•çš„ã«è©¦è¡Œã•ã‚Œã‚‹',
        'å˜èªã®çµ„ã¿åˆã‚ã›ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒäºˆæ¸¬å¯èƒ½',
        'è¨€èªçš„ãªæ„å‘³ã‚’æŒã¤ãŸã‚è¨˜æ†¶ã—ã‚„ã™ãã€å¤šç”¨ã•ã‚Œã‚‹',
      ],
      attackMethods: [
        {
          name: 'è¾æ›¸æ”»æ’ƒ',
          description: 'å˜èªè¾æ›¸ã‚’ä½¿ç”¨ã—ãŸç·å½“ãŸã‚Šæ”»æ’ƒ',
          timeToBreak: 'æ•°åˆ†ã€œæ•°æ™‚é–“',
          difficulty: 'easy' as const,
        },
        {
          name: 'ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ”»æ’ƒ',
          description: 'è¾æ›¸æ”»æ’ƒã¨æ–‡å­—å¤‰æ›ã®çµ„ã¿åˆã‚ã›',
          timeToBreak: 'æ•°æ™‚é–“ã€œæ•°æ—¥',
          difficulty: 'medium' as const,
        },
      ],
      realWorldExamples: [
        'John the Ripperãªã©ã®ãƒ„ãƒ¼ãƒ«ã§ç°¡å˜ã«ç ´ã‚‰ã‚Œã‚‹',
        'ä¼æ¥­ã®æƒ…å ±æ¼æ´©äº‹ä»¶ã§é »ç¹ã«ç™ºè¦‹ã•ã‚Œã‚‹',
        'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦æ¸¬å®šã§ã€Œå¼±ã„ã€ã¨åˆ¤å®šã•ã‚Œã‚‹',
      ],
    },
    sequential: {
      title: 'é€£ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã®å±é™ºæ€§',
      explanation:
        'é€£ç¶šã™ã‚‹æ–‡å­—ã‚„æ•°å­—ã¯äººé–“ã«ã¨ã£ã¦è¦šãˆã‚„ã™ã„ã§ã™ãŒã€æ”»æ’ƒè€…ã«ã‚‚äºˆæ¸¬ã—ã‚„ã™ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚',
      whyVulnerable: [
        'ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒéå¸¸ã«äºˆæ¸¬å¯èƒ½',
        'è‡ªå‹•åŒ–ã•ã‚ŒãŸæ”»æ’ƒã§ç°¡å˜ã«ç™ºè¦‹ã•ã‚Œã‚‹',
        'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…åˆ—ã«åŸºã¥ãæ”»æ’ƒã«è„†å¼±',
      ],
      attackMethods: [
        {
          name: 'ãƒ‘ã‚¿ãƒ¼ãƒ³æ”»æ’ƒ',
          description: 'é€£ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç‹™ã£ãŸæ”»æ’ƒ',
          timeToBreak: 'æ•°åˆ†',
          difficulty: 'trivial' as const,
        },
        {
          name: 'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¦ã‚©ãƒ¼ã‚¯æ”»æ’ƒ',
          description: 'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…åˆ—ã«åŸºã¥ãæ”»æ’ƒ',
          timeToBreak: 'æ•°åˆ†ã€œæ•°æ™‚é–“',
          difficulty: 'easy' as const,
        },
      ],
      realWorldExamples: [
        '"123456"ã¯ä¸–ç•Œã§æœ€ã‚‚ä½¿ç”¨ã•ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
        '"qwerty"ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é…åˆ—æ”»æ’ƒã®å…¸å‹ä¾‹',
        'ATMã®æš—è¨¼ç•ªå·ã§ã‚‚åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå•é¡Œã¨ãªã£ã¦ã„ã‚‹',
      ],
    },
  };

  const typeContent =
    baseContent[vulnerabilityType as keyof typeof baseContent];
  return typeContent || baseContent.common;
}

function generateRecommendations(
  vulnerabilities: VulnerabilityIssue[]
): string[] {
  const recommendations: string[] = [];

  if (vulnerabilities.some(v => v.type === 'length')) {
    recommendations.push('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’12æ–‡å­—ä»¥ä¸Šã«ã™ã‚‹');
  }

  if (vulnerabilities.some(v => v.type === 'character-set')) {
    recommendations.push('å¤§æ–‡å­—ã€å°æ–‡å­—ã€æ•°å­—ã€è¨˜å·ã‚’çµ„ã¿åˆã‚ã›ã‚‹');
  }

  if (vulnerabilities.some(v => v.type === 'common')) {
    recommendations.push('ä¸€èˆ¬çš„ãªå˜èªã‚„çµ„ã¿åˆã‚ã›ã‚’é¿ã‘ã‚‹');
  }

  if (vulnerabilities.some(v => v.type === 'pattern')) {
    recommendations.push('é€£ç¶šã™ã‚‹æ–‡å­—ã‚„ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¿ã‘ã‚‹');
  }

  // åŸºæœ¬çš„ãªæ¨å¥¨äº‹é …ã‚’è¿½åŠ 
  recommendations.push(
    'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹',
    'å®šæœŸçš„ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹',
    'äºŒè¦ç´ èªè¨¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹'
  );

  return recommendations;
}

function generateComparisonExample(
  weakPassword: string,
  vulnerabilities: VulnerabilityIssue[]
): { weakPassword: string; strongPassword: string; explanation: string } {
  // è„†å¼±æ€§ã«åŸºã¥ã„ã¦å¼·ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ä¾‹ã‚’ç”Ÿæˆ
  let strongPassword = '';
  let explanation = '';

  if (vulnerabilities.some(v => v.type === 'length')) {
    strongPassword = 'MyStr0ng&SecureP@ssw0rd2024!';
    explanation =
      'é•·ã•ã‚’16æ–‡å­—ä»¥ä¸Šã«ã—ã€è¤‡æ•°ã®æ–‡å­—ç¨®ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å®‰å…¨æ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚';
  } else if (vulnerabilities.some(v => v.type === 'common')) {
    strongPassword = 'Tr@il&Hiking#2024$Adventure';
    explanation =
      'ä¸€èˆ¬çš„ãªå˜èªã‚’é¿ã‘ã€å€‹äººçš„ãªæ„å‘³ã‚’æŒã¤ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¨˜å·ã¨æ•°å­—ã§å¼·åŒ–ã—ã¦ã„ã¾ã™ã€‚';
  } else if (vulnerabilities.some(v => v.type === 'pattern')) {
    strongPassword = 'R@nd0m&Secure#Ch@rs!Mix';
    explanation =
      'é€£ç¶šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¿ã‘ã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—é…ç½®ã§äºˆæ¸¬å›°é›£ã«ã—ã¦ã„ã¾ã™ã€‚';
  } else {
    strongPassword = 'Complex&Secure#P@ssw0rd!2024';
    explanation =
      'è¤‡æ•°ã®æ–‡å­—ç¨®ã‚’çµ„ã¿åˆã‚ã›ã€ååˆ†ãªé•·ã•ã‚’ç¢ºä¿ã—ãŸå®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚';
  }

  return {
    weakPassword,
    strongPassword,
    explanation,
  };
}

// è„†å¼±æ€§ã‚¹ã‚³ã‚¢ã«åŸºã¥ãè©•ä¾¡
export function getVulnerabilityLevel(score: number): {
  level: 'low' | 'medium' | 'high' | 'critical';
  label: string;
  color: string;
  icon: string;
} {
  if (score >= 80) {
    return { level: 'critical', label: 'æ¥µã‚ã¦å±é™º', color: 'red', icon: 'ğŸ’€' };
  } else if (score >= 60) {
    return { level: 'high', label: 'é«˜ãƒªã‚¹ã‚¯', color: 'red', icon: 'ğŸ”´' };
  } else if (score >= 30) {
    return { level: 'medium', label: 'ä¸­ãƒªã‚¹ã‚¯', color: 'orange', icon: 'ğŸŸ ' };
  } else {
    return { level: 'low', label: 'ä½ãƒªã‚¹ã‚¯', color: 'yellow', icon: 'ğŸŸ¡' };
  }
}
